<?xml version="1.0" encoding="UTF-8"?>

<project name="MoodleTravisPluginScript" description="Use targets from this Phing file for the 'script' section of the .travis.yml file." default="PHPUnit">
    <property name="COMPONENT" value="${env.COMPONENT}" description="Moodle component, EG: mod_forum"/>
    <property name="COMPONENT_DIR" value="${env.COMPONENT_DIR}" description="Moodle component directory, EG: mod/forum"/>
    <property name="TRAVIS_BUILD_DIR" value="${env.TRAVIS_BUILD_DIR}" description="This is where Travis cloned the plugin"/>
    <resolvepath propertyName="BUILD_DIR" file="${project.basedir}/.." description="Where everything is built, like Moodle"/>
    <property name="MOODLE_DIR" value="${BUILD_DIR}/moodle" description="Directory where Moodle is cloned to"/>
    <property name="MOODLE_COMPONENT_DIR" value="${MOODLE_DIR}/${COMPONENT_DIR}" description="Absolute path to Moodle component director, EG: /path/to/mod/forum"/>
    <property name="BEHAT_CONFIG" value="${BUILD_DIR}/moodledata/behat_moodledata/behat/behat.yml" description="Absolute path to Behat config file"/>
    <available property="PHPUNIT_READY" file="${MOODLE_DIR}/PHPUNIT_READY" description="Flag for if PHPUnit has been installed and ready to be run"/>
    <available property="BEHAT_READY" file="${MOODLE_DIR}/BEHAT_READY" description="Flag for if Behat has been installed and ready to be run"/>
    <available property="MOODLE_READY" file="${MOODLE_DIR}/MOODLE_READY" description="Flag for if Moodle has been installed"/>
    <property name="MOODLE_READY_FAIL" value="The Moodle install does not exist, something went wrong with the install" description="Error message"/>

    <target name="ReportProperties">
        <!-- Helps with debugging. -->
        <echo message="COMPONENT: ${COMPONENT}"/>
        <echo message="COMPONENT_DIR: ${COMPONENT_DIR}"/>
        <echo message="TRAVIS_BUILD_DIR: ${TRAVIS_BUILD_DIR}"/>
        <echo message="BUILD_DIR: ${BUILD_DIR}"/>
        <echo message="MOODLE_DIR: ${MOODLE_DIR}"/>
        <echo message="MOODLE_COMPONENT_DIR: ${MOODLE_COMPONENT_DIR}"/>
        <echo message="BEHAT_CONFIG: ${BEHAT_CONFIG}"/>
        <echo message="PHPUNIT_READY: ${PHPUNIT_READY}"/>
        <echo message="BEHAT_READY: ${BEHAT_READY}"/>
        <echo message="MOODLE_READY: ${MOODLE_READY}"/>
    </target>

    <target name="Behat" description="Run Behat tests">
        <fail unless="BEHAT_READY" message="Behat is not ready to run, something went wrong with the install"/>
        <echo message="Running Behat tests for ${COMPONENT}"/>
        <exec command="${MOODLE_DIR}/vendor/bin/behat --config ${BEHAT_CONFIG} --tags @${COMPONENT}" dir="${MOODLE_DIR}" passthru="true" level="info" checkreturn="true"/>
    </target>

    <target name="PHPUnit" description="Run PHPUnit tests">
        <fail unless="PHPUNIT_READY" message="PHPUnit is not ready to run, something went wrong with the install"/>
        <echo message="Running PHPUnit tests for ${COMPONENT}"/>
        <exec command="${MOODLE_DIR}/vendor/bin/phpunit --testsuite &quot;${COMPONENT}_testsuite&quot;" dir="${MOODLE_DIR}" passthru="true" level="info" checkreturn="true"/>
    </target>

    <target name="PHPLint" description="Run PHP Lint on the plugin">
        <fail unless="MOODLE_READY" message="${MOODLE_READY_FAIL}"/>
        <echo message="Running PHP Linting on ${MOODLE_COMPONENT_DIR}"/>
        <phplint deprecatedAsError="true" haltonfailure="true">
            <fileset dir="${MOODLE_COMPONENT_DIR}">
                <include name="**/*.php"/>
            </fileset>
        </phplint>
        <echo message="Done with PHP linting"/>
    </target>

    <target name="CodeChecker" description="Run Moodle Code Checker">
        <fail unless="MOODLE_READY" message="${MOODLE_READY_FAIL}"/>
        <echo message="Running Moodle Code Checker on ${MOODLE_COMPONENT_DIR}"/>
        <phpcodesniffer standard="${MOODLE_DIR}/local/codechecker/moodle" haltonerror="true" reportWidth="120">
            <fileset dir="${MOODLE_COMPONENT_DIR}">
                <!-- List specific files to avoid processing XML, txt, etc files. -->
                <include name="**/*.php"/>
                <include name="**/*.js"/>
                <!-- Exclude YUI build artifacts. -->
                <exclude name="yui/build/**"/>
            </fileset>
        </phpcodesniffer>
    </target>

    <target name="PHPCPD" description="Run PHP Copy/Paste Detector">
        <fail unless="MOODLE_READY" message="${MOODLE_READY_FAIL}"/>
        <echo message="Running PHP Copy/Paste Detector on ${MOODLE_COMPONENT_DIR}"/>
        <phpcpd>
            <fileset dir="${MOODLE_COMPONENT_DIR}">
                <include name="**/*.php"/>
            </fileset>
        </phpcpd>
    </target>

    <target name="PHPMD" description="Run PHP Mess Detector">
        <fail unless="MOODLE_READY" message="${MOODLE_READY_FAIL}"/>
        <echo message="Running PHP Mess Detector on ${MOODLE_COMPONENT_DIR}"/>
        <phpmd rulesets="${project.basedir}/res/ruleset/phpmd.xml" file="${MOODLE_COMPONENT_DIR}"/>
    </target>
</project>
